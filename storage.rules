rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Emergency Images - Public read (for emergency responders), authenticated write
    match /emergency_images/{userId}/{fileName} {
      // Only authenticated users can upload
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Anyone can read (important for emergency response)
      // This allows admin dashboard to load images without CORS issues
      allow read: if true;
    }
    
    // PWD ID Images - User can upload their own, Admin can read all
    match /pwdId/{userId}/{fileName} {
      // Users can only upload their own PWD ID images
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Users can read their own images
      // Admins can read all images for verification
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.token.email.matches('.*admin.*') ||
        request.auth.token.email in [
          'admin@safeapp.com',
          'superadmin@safeapp.com',
          'iamadmin@gmail.com'
        ]
      );
    }
    
    // Default: Allow authenticated users
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}
